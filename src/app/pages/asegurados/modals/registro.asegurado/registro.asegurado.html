<dialog #modalDialog id="modal_registro_asegurado" class="modal" (keydown)="onKeyDown($event)">
    <div class="modal-box w-11/12 max-w-4xl p-0">
        <!-- Header -->
        <div class="bg-gradient-to-r bg-indigo-950 text-white p-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <ng-icon name="heroUser"></ng-icon>
                <h1>{{ aseguradoUpdt ? 'Editar' : 'Registrar' }} Asegurado</h1>
            </div>
        </div>

        <!-- Form -->
        <form [formGroup]="aseguradoForm" (ngSubmit)="onSubmit()" class="p-4 sm:p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">

                <!-- Nombre Completo -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Nombre Completo <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        formControlName="nombre" 
                        placeholder="Ingrese el nombre completo"
                        (keypress)="onlyLetters($event)"
                        class="input input-bordered w-full focus:input-primary" 
                    />
                    <div *ngIf="aseguradoForm.get('nombre')?.invalid && aseguradoForm.get('nombre')?.touched" 
                        class="text-red-500 text-xs mt-1">
                        <span *ngIf="aseguradoForm.get('nombre')?.errors?.['required']">
                            El nombre es requerido
                        </span>
                        <span *ngIf="aseguradoForm.get('nombre')?.errors?.['pattern']">
                            El nombre solo debe contener letras
                        </span>
                    </div>
                </div>

                <!-- Cédula -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Cédula <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        formControlName="cedula" 
                        placeholder="xxxxxxxxxx"
                        maxlength="10"
                        (keypress)="onlyNumbers($event)"
                        class="input input-bordered w-full focus:input-primary" 
                    />
                    <div *ngIf="aseguradoForm.get('cedula')?.invalid && aseguradoForm.get('cedula')?.touched" 
                        class="text-red-500 text-xs mt-1">
                        <span *ngIf="aseguradoForm.get('cedula')?.errors?.['required']">
                            La cédula es requerida
                        </span>
                        <span *ngIf="aseguradoForm.get('cedula')?.errors?.['pattern']">
                            La cédula debe tener exactamente 10 dígitos
                        </span>
                    </div>
                </div>

                <!-- Teléfono -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Teléfono <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        formControlName="telefono" 
                        placeholder="xxxxxxxxxx"
                        maxlength="10"
                        (keypress)="onlyNumbers($event)"
                        class="input input-bordered w-full focus:input-primary" 
                    />
                    <div *ngIf="aseguradoForm.get('telefono')?.invalid && aseguradoForm.get('telefono')?.touched" 
                        class="text-red-500 text-xs mt-1">
                        <span *ngIf="aseguradoForm.get('telefono')?.errors?.['required']">
                            El teléfono es requerido
                        </span>
                        <span *ngIf="aseguradoForm.get('telefono')?.errors?.['pattern']">
                            El teléfono debe tener exactamente 10 dígitos
                        </span>
                    </div>
                </div>
                
                <!-- Fecha de Nacimiento -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Fecha de Nacimiento <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="date" 
                        formControlName="fechaNacimiento"
                        [max]="today"
                        class="input input-bordered w-full focus:input-primary" 
                        (change)="onFechaNacimientoChange($event)"
                    />
                    <div *ngIf="aseguradoForm.get('fechaNacimiento')?.invalid && aseguradoForm.get('fechaNacimiento')?.touched" 
                        class="text-red-500 text-xs mt-1">
                        La fecha de nacimiento es requerida
                    </div>
                </div>

                <!-- Edad (calculada automáticamente) -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Edad
                    </label>
                    <input 
                        type="text" 
                        formControlName="edad"
                        placeholder="Se calcula automáticamente"
                        readonly
                        class="input input-bordered w-full bg-gray-100 cursor-not-allowed" 
                    />
                </div>

                <!-- Checkbox para seguro -->
                <div class="md:col-span-2 bg-blue-50 p-4 rounded-lg">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" formControlName="seleccionarSeguros" class="checkbox checkbox-primary" />
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-600" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <span class="text-sm font-semibold text-gray-700">Asignarle seguro(s)</span>
                        </div>
                    </label>
                </div>

                <!-- Selección de Seguros -->
                <div *ngIf="aseguradoForm.get('seleccionarSeguros')?.value"
                    class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Seguros <span class="text-red-500">*</span>
                    </label>
                    <p class="text-xs text-gray-500 mb-3">Seleccione uno o más seguros</p>
                    
                    <!-- Loading state -->
                    <div *ngIf="cargandoSeguros" class="flex justify-center items-center py-8">
                        <span class="loading loading-spinner loading-md"></span>
                        <span class="ml-2 text-gray-600">Cargando seguros...</span>
                    </div>

                    <!-- Seguros disponibles -->
                    <div *ngIf="!cargandoSeguros" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div 
                            *ngFor="let seguro of segurosDisponibles" 
                            class="border-2 rounded-lg p-4 cursor-pointer transition-all hover:shadow-md"
                            [class.border-indigo-500]="isSeguroSeleccionado(seguro.idSeguro)"
                            [class.bg-indigo-50]="isSeguroSeleccionado(seguro.idSeguro)"
                            [class.border-gray-200]="!isSeguroSeleccionado(seguro.idSeguro)"
                        >
                            <div class="flex items-start gap-3">
                                <input 
                                    type="checkbox" 
                                    [checked]="aseguradoForm.get('seguros')?.value?.includes(seguro.idSeguro) || false"
                                    class="checkbox checkbox-primary mt-1"
                                    (click)="toggleSeguro(seguro.idSeguro); $event.stopPropagation()"
                                />
                                <div class="flex-1">
                                    <div class="flex items-center justify-between">
                                        <h3 class="font-semibold text-gray-800">{{ seguro.nombre }}</h3>
                                        <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                                            {{ seguro.codigo }}
                                        </span>
                                    </div>
                                    
                                    <div class="mt-2 space-y-1">
                                        <p class="text-sm text-gray-600">
                                            <span class="font-medium">Suma Asegurada:</span> 
                                            ${{ seguro.sumaAsegurada | number:'1.2-2' }}
                                        </p>
                                        <p class="text-sm text-gray-600">
                                            <span class="font-medium">Prima:</span> 
                                            ${{ seguro.prima | number:'1.2-2' }}
                                        </p>
                                        <p *ngIf="seguro.edadMin || seguro.edadMax" 
                                           class="text-xs text-gray-500">
                                            <span class="font-medium">Edad:</span> 
                                            {{ seguro.edadMin || 0 }} - {{ seguro.edadMax || '∞' }} años
                                        </p>
                                    </div>

                                    
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje si no hay seguros -->
                    <div *ngIf="!cargandoSeguros && segurosDisponibles.length === 0" 
                         class="text-center py-8 text-gray-500">
                        <ng-icon name="heroInformationCircle" size="24"></ng-icon>
                        <p class="mt-2">No hay seguros disponibles</p>
                    </div>
                    
                    <!-- Error de validación -->
                    <div *ngIf="aseguradoForm.get('seguros')?.invalid && aseguradoForm.get('seguros')?.touched" 
                        class="text-red-500 text-xs mt-2">
                        Debe seleccionar al menos un seguro
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mt-6 sm:mt-8 justify-end">
                <button 
                    type="button" 
                    (click)="closeModal()" 
                    class="btn btn-soft order-2 sm:order-1"
                >
                    <ng-icon name="heroXMark"></ng-icon>
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    [disabled]="aseguradoForm.invalid" 
                    class="btn btn-primary order-1 sm:order-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    {{ aseguradoUpdt ? 'Actualizar' : 'Registrar' }} Asegurado
                </button>
            </div>
        </form>
    </div>
</dialog>